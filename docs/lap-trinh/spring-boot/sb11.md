[SB11] HÆ°á»›ng dáº«n Spring Boot JPA + MySQL
=============================================




Description

Äá»ƒ Ä‘i tiáº¿p trong series Spring Boot nÃ y, tÃ´i khÃ´ng thá»ƒ bá» qua má»™t pháº§n quan trá»ng Ä‘Ã³ lÃ  giao tiáº¿p vá»›i Database.

- Giá»›i thiá»‡u
- Spring Boot JPA
- CÃ i Ä‘áº·t
- Táº¡o Table vÃ  dá»¯ liá»‡u
- Táº¡o Model User
- Váº¥n Ä‘á» cá»§a Hibernate truyá»n thá»‘ng
- JpaRepository
- Demo
- Káº¿t

### **Giá»›i thiá»‡u**

Äá»ƒ Ä‘i tiáº¿p trong series Spring Boot nÃ y, tÃ´i khÃ´ng thá»ƒ bá» qua má»™t pháº§n quan trá»ng Ä‘Ã³ lÃ  giao tiáº¿p vá»›i Database.

Náº¿u báº¡n cáº§n xem láº¡i cÃ¡c bÃ i trÆ°á»›c, thÃ¬ nÃ³ á»Ÿ Ä‘Ã¢y:

1. [ğŸ“SB8] Táº¡o Web Helloworld vá»›i @Controller + Thymeleaf
2. [ğŸ§µSB9] Giáº£i thÃ­ch cÃ¡ch Thymeleaf váº­n hÃ nh + Expression + Demo Full
3. [ğŸ²SB10] @RequestMapping + @PostMapping + @ModelAttribute + @RequestParam + Web To-Do vá»›i Thymeleaf

VÃ¬ thiáº¿u pháº§n káº¿t ná»‘i vá»›i Database nÃªn chÃºng ta chÆ°a thá»ƒ hoÃ n thiá»‡n Ä‘Æ°á»£c trang Web cá»§a mÃ¬nh, trong bÃ i nÃ y chÃºng ta sáº½ tÃ¬m hiá»ƒuÂ **Spring Boot JPA**.

Trong bÃ i cÃ³ Ä‘á» cáº­p kiáº¿n thá»©c:

1. Hibernate
2. Lombok

### **Spring Boot JPA**

**Spring Boot JPA**Â lÃ  má»™t pháº§n trong há»‡ sinh thÃ¡i Spring Data, nÃ³ táº¡o ra má»™t layer á»Ÿ giá»¯a táº§ng service vÃ  database, giÃºp chÃºng ta thao tÃ¡c vá»›i database má»™t cÃ¡ch dá»… dÃ ng hÆ¡n, tá»± Ä‘á»™ng config vÃ  giáº£m thiá»ƒu code thá»«a thÃ£i.

**Spring Boot JPA**Â Ä‘Ã£ wrapper Hibernate vÃ  táº¡o ra má»™t interface máº¡nh máº½. Náº¿u nhÆ° báº¡n gáº·p khÃ³ khÄƒn khi lÃ m viá»‡c vá»›i Hibernate thÃ¬ Ä‘á»«ng lo, báº¡n hÃ£y Ä‘á»ƒÂ **Spring JPA**Â lÃ m há»™.

### **CÃ i Ä‘áº·t**

Äá»ƒ thÃªm Spring JPA vÃ o project, báº¡n cáº§n thÃªm dependencyÂ `spring-boot-starter-data-jpa`.

NgoÃ i ra, Ä‘á»ƒ connect tá»›i MySql, chÃºng ta cáº§n driver tÆ°Æ¡ng á»©ng, vÃ¬ váº­y pháº£i bá»• sung thÃªm cáº£ dependencyÂ `mysql-connector-java`Â vÃ oÂ _pom.xml_.

_pom.xml_

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <packaging>pom</packaging>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.0.5.RELEASE</version>
        <relativePath /> <!-- lookup parent from repository -->
    </parent>
    <groupId>me.loda.spring</groupId>
    <artifactId>spring-boot-learning</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>spring-boot-learning</name>
    <description>Everything about Spring Boot</description>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>

        <!--spring mvc, rest-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--spring jpa-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>

        <!-- mysql connector -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
        </plugin>
        </plugins>
    </build>

</project>
```

Cáº¥u trÃºc thÆ° má»¥c:

!image

### **Táº¡o Table vÃ  dá»¯ liá»‡u**

TrÆ°á»›c khi báº¯t Ä‘áº§u, chÃºng ta cáº§n táº¡o ra dá»¯ liá»‡u trong Database. á» Ä‘Ã¢y tÃ´i chá»nÂ `MySQL`.

DÆ°á»›i Ä‘Ã¢y lÃ  SQL Script Ä‘á»ƒ táº¡o DATABASEÂ `micro_db`. Chá»©a má»™t TABLE duy nháº¥t lÃ Â `User`.

Khi cháº¡y script nÃ y, nÃ³ sáº½ tá»± Ä‘á»™ng insert vÃ o db 100Â `User`.

```
CREATE DATABASE micro_db;
use micro_db;
CREATE TABLE `user`
(
  `id`         bigint(20) NOT NULL      AUTO_INCREMENT,
  `hp`   		int  NULL          DEFAULT NULL,
  `stamina`    int                  DEFAULT NULL,
  `atk`      int                    DEFAULT NULL,
  `def`      int                    DEFAULT NULL,
  `agi`      int                    DEFAULT NULL,
  PRIMARY KEY (`id`)
);

DELIMITER $$
CREATE PROCEDURE generate_data()
BEGIN
  DECLARE i INT DEFAULT 0;
  WHILE i < 100 DO
    INSERT INTO `user` (`hp`,`stamina`,`atk`,`def`,`agi`) VALUES (i,i,i,i,i);
    SET i = i + 1;
  END WHILE;
END$$
DELIMITER ;

CALL generate_data();
```

Sau khi cháº¡y xong script trÃªn, chÃºng ta kiá»ƒm tra database Ä‘Ã£ cÃ³ dá»¯ liá»‡u chÆ°a.

!image

### **Táº¡o Model User**

Khi Ä‘Ã£ cÃ³ dá»¯ liá»‡u trong Database. ChÃºng ta sáº½ táº¡o má»™t Class trong Java Ä‘á»ƒ mapping thÃ´ng tin.

Pháº§n nÃ y chÃºng ta cáº§n cÃ³ má»™t chÃºt kiáº¿n thá»©c vá» Hibernate. Náº¿u báº¡n chÆ°a biáº¿t nhá»¯ng Annotation á»Ÿ dÆ°á»›i Ä‘Ã¢y Ä‘á»ƒ lÃ m gÃ¬ thÃ¬ hÃ£y táº¡m dá»«ng vÃ Â tÃ¬m hiá»ƒu Hibernate táº¡i Ä‘Ã¢y.

_User.java_

```
@Entity
@Table(name = "user")
@Data
public class User implements Serializable {
    private static final long serialVersionUID = -297553281792804396L;

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // Mapping thÃ´ng tin biáº¿n vá»›i tÃªn cá»™t trong Database
    @Column(name = "hp")
    private int hp;
    @Column(name = "stamina")
    private int stamina;

    // Náº¿u khÃ´ng Ä‘Ã¡nh dáº¥u @Column thÃ¬ sáº½ mapping tá»± Ä‘á»™ng theo tÃªn biáº¿n
    private int atk;
    private int def;
    private int agi;
}
```

Tá»›i Ä‘Ã¢y lÃ  chÃºng ta lÃ m Ä‘Æ°á»£c ná»­a Ä‘Æ°á»ng rá»“i.

### **Váº¥n Ä‘á» cá»§a Hibernate truyá»n thá»‘ng**

ThÃ´ng thÆ°á»ng, khi báº¡n Ä‘Ã£ Ä‘á»‹nh nghÄ©aÂ `Entity`Â tÆ°Æ¡ng á»©ng vá»›iÂ `Table`Â trong DB thÃ´ng qua Hibernate. ThÃ¬ nhiá»‡m vá»¥ tiáº¿p theo sáº½ lÃ  táº¡o ra cÃ¡c class thao tÃ¡c vá»›i DB.

VÃ­ dá»¥ muá»‘n query láº¥y táº¥t cáº£Â `User`Â báº±ng Hibernate truyá»n thá»‘ng sáº½ nhÆ° sau:

```
// Giáº£ sá»­ Ä‘Ã£ cÃ³ Ä‘á»‘i tÆ°á»£ng session rá»“i
Session session = getSession();

try {
    // Táº¥t cáº£ cÃ¡c lá»‡nh hÃ nh Ä‘á»™ng vá»›i DB thÃ´ng qua Hibernate
    // Ä‘á»u pháº£i náº±m trong 1 giao dá»‹ch (Transaction)
    // Báº¯t Ä‘áº§u giao dá»‹ch
    session.getTransaction().begin();

    // Táº¡o má»™t query

    String sql = "Select u from " + User.class.getName() + " u ";

    // Táº¡o Ä‘á»‘i tÆ°á»£ng Query.
    Query<User> query = session.createQuery(sql);

    // Thá»±c hiá»‡n truy váº¥n vÃ  láº¥y ra dá»¯ liá»‡u.
    List<User> users = query.getResultList();

    // In ra mÃ n hÃ¬nh
    for (User user : users) {
        System.out.println(user);
    }

    // Commit dá»¯ liá»‡u vÃ  káº¿t thÃºc session.
    session.getTransaction().commit();
} catch (Exception e) {
    e.printStackTrace();
    // Rollback trong trÆ°á»ng há»£p cÃ³ lá»—i xáº©y ra.
    session.getTransaction().rollback();
}
```

Máº·c dÃ¹ Hibernate Ä‘Ã£ lÃ m ráº¥t tá»‘t vÃ  giáº£m thiá»ƒu code cho viá»‡c thao tÃ¡c vá»›i Database xuá»‘ng rá»“i, nhá»¯ng nÃ³ váº«n chÆ°a háº³n lÃ  dá»… dÃ ng :(

Má»¥c Ä‘Ã­ch ban Ä‘áº§u cá»§a Hibernate lÃ  giÃºp ngÆ°á»i láº­p trÃ¬nh dá»… sá»­ dá»¥ng, tuy nhiÃªn, trÃªn thá»±c táº¿, nhiá»u ngÆ°á»i gáº·p khÃ³ khÄƒn trong viá»‡c sá»­ dá»¥ng vá»›i Hibernate hÆ¡n cáº£Â `jdbc`.

Náº¯m Ä‘Æ°á»£c váº¥n Ä‘á» nÃ y,Â **Spring Data**Â Ä‘Ã£ wrapper lÃªn Hibernate má»™t lá»›p ná»¯a gá»i lÃ Â **Spring JPA**, giÃºp cho má»i thao tÃ¡c vá»›i DB cá»§a chÃºng ta rÃºt ngáº¯n xuá»‘ng cÃ²n 1 dÃ²ng vÃ  táº¥t nhiÃªn lÃ  lÃ m má» Hibernate xuá»‘ng Ä‘Ã¡ng ká»ƒ Ä‘á»ƒ trÃ¡nh ráº¯c rá»‘i cho ngÆ°á»i láº­p trÃ¬nh.

### **JpaRepository**

Äá»ƒ sá»­ dá»¥ngÂ **Spring JPA**, báº¡n cáº§n sá»­ dá»¥ng interfaceÂ `JpaRepository`.

YÃªu cáº§u cá»§a interface nÃ y Ä‘Ã³ lÃ  báº¡n pháº£i cung cáº¥p 2 thÃ´ng tin:

1. Entity (Äá»‘i tÆ°á»£ng tÆ°Æ¡ng á»©ng vá»›i Table trong DB)
2. Kiá»ƒu dá»¯ liá»‡u cá»§a khÃ³a chÃ­nh (primary key)

VÃ­ dá»¥: TÃ´i muá»‘n láº¥y thÃ´ng tin cá»§a báº£ngÂ `User`Â thÃ¬ lÃ m nhÆ° sau:

```
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
}
```

Váº­y thÃ´i,Â `@Repository`Â Ä‘Ã¡nh dáº¥uÂ `UserRepository`Â lÃ  má»™t Bean vÃ  chá»‹u trÃ¡ch nhiá»‡m giao tiáº¿p vá»›i DB.

**Spring Boot**Â sáº½ tá»± tÃ¬m tháº¥y vÃ  khá»Ÿi táº¡o ra Ä‘á»‘i tÆ°á»£ngÂ `UserRepository`Â trong Context. Viá»‡c táº¡o raÂ `UserRepository`Â hoÃ n toÃ n tá»± Ä‘á»™ng vÃ  tá»± config, vÃ¬ chÃºng ta Ä‘Ã£ káº¿ thá»«aÂ `JpaRepository`.

BÃ¢y giá», viá»‡c láº¥y ra toÃ n bá»™Â `User`Â sáº½ nhÆ° sau:

```
@Autowired
UserRepository userRepository;

userRepository.findAll()
                .forEach(System.out::println);
```

ÄÆ¡n giáº£n vÃ  ngáº¯n gá»n hÆ¡n ráº¥t nhiá»u.

Náº¿u báº¡n tÃ¬m kiáº¿m thÃ¬ sáº½ tháº¥yÂ `UserRepository`Â cÃ³ hÃ ng chá»¥c method mÃ  chÃºng ta khÃ´ng cáº§n viáº¿t láº¡i ná»¯a. VÃ¬ nÃ³ káº¿ thá»«aÂ `JpaRepository`Â rá»“i.

!image

### **Demo**

BÃ¢y giá» chÃºng ta sáº½ lÃ m á»©ng dá»¥ng Demo cÃ¡c tÃ­nh nÄƒng cÆ¡ báº£n vá»›iÂ `JpaRepository`

BÆ°á»›c Ä‘áº§u tiÃªn lÃ  config thÃ´ng tin vá» MySQL trongÂ `application.properties`

_application.properties_

```
spring.datasource.url=jdbc:mysql://localhost:3306/micro_db?useSSL=false
spring.datasource.username=root
spring.datasource.password=root

## Hibernate Properties
# The SQL dialect makes Hibernate generate better SQL for the chosen database
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5InnoDBDialect
# Hibernate ddl auto (create, create-drop, validate, update)
spring.jpa.hibernate.ddl-auto = update

logging.level.org.hibernate = ERROR
```

**Spring JPA**Â sáº½ tá»± káº¿t ná»‘i cho chÃºng ta, mÃ  khÃ´ng cáº§n thÃªm má»™t Ä‘oáº¡n code nÃ o cáº£.

_User.java_

```
@Entity
@Table(name = "user")
@Data
public class User implements Serializable {
    private static final long serialVersionUID = -297553281792804396L;

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // Mapping thÃ´ng tin biáº¿n vá»›i tÃªn cá»™t trong Database
    @Column(name = "hp")
    private int hp;
    @Column(name = "stamina")
    private int stamina;

    // Náº¿u khÃ´ng Ä‘Ã¡nh dáº¥u @Column thÃ¬ sáº½ mapping tá»± Ä‘á»™ng theo tÃªn biáº¿n
    private int atk;
    private int def;
    private int agi;
}
```

_App.java_

```
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.ApplicationContext;

import lombok.RequiredArgsConstructor;

@SpringBootApplication
@RequiredArgsConstructor
public class App {
    public static void main(String[] args) {
        ApplicationContext context = SpringApplication.run(App.class, args);
        UserRepository userRepository = context.getBean(UserRepository.class);

        // Láº¥y ra toÃ n bá»™ user trong db
        userRepository.findAll()
                      .forEach(System.out::println);

        // LÆ°u user xuá»‘ng database
        User user = userRepository.save(new User());
        // Khi lÆ°u xong, nÃ³ tráº£ vá» User Ä‘Ã£ lÆ°u kÃ¨m theo Id.
        System.out.println("User vá»«a lÆ°u cÃ³ ID: " + user.getId());
        Long userId = user.getId();
        // Cáº­p nháº­t user.
        user.setAgi(100);
        // Update user
        // LÆ°u Ã½, lÃºc nÃ y Ä‘á»‘i tÆ°á»£ng user Ä‘Ã£ cÃ³ Id.
        // NÃªn nÃ³ sáº½ update vÃ o Ä‘á»‘i tÆ°á»£ng cÃ³ Id nÃ y
        // chá»© khÃ´ng insert má»™t báº£n ghi má»›i
        userRepository.save(user);

        // Query láº¥y ra user vá»«a xong Ä‘á»ƒ kiá»ƒm tra xem.
        User user2 = userRepository.findById(userId).get();
        System.out.println("User: " + user);
        System.out.println("User2: " + user2);

        // XÃ³a User khá»i DB
        userRepository.delete(user);

        // In ra kiá»ƒm tra xem userId cÃ²n tá»“n táº¡i trong DB khÃ´ng
        User user3 = userRepository.findById(userId).orElse(null);
        System.out.println("User3: " + user2);

    }

}
```

OUTPUT chÆ°Æ¡ng trÃ¬nh:

```
User vá»«a lÆ°u cÃ³ ID: 104
// sau khi update, cáº£ 2 Ä‘á»‘i tÆ°á»£ng user Ä‘á»u cÃ³ giÃ¡ trá»‹ agi má»›i
User: User(id=104, hp=0, stamina=0, atk=0, def=0, agi=100)
User2: User(id=104, hp=0, stamina=0, atk=0, def=0, agi=100)
// Sau khi xÃ³a, user khÃ´ng cÃ²n tá»“n táº¡i
User3: null
```

### **Káº¿t**

Tá»›i Ä‘Ã¢y, tÃ´i muá»‘n báº¡n Ä‘á»c thÃªm vá» cÃ¡c bÃ i viáº¿t sau Ä‘Ã¢y Ä‘á»ƒ hiá»ƒu hÆ¡n vá» JPA:

2. [ğŸª‚ã€ŒJpaã€HÆ°á»›ng dáº«n sá»­ dá»¥ng @OneToOne]()
3. [ğŸš…ã€ŒJpaã€HÆ°á»›ng dáº«n @OneToMany vÃ  @ManyToOne]()
4. [ğŸ›µã€ŒJpaã€HÆ°á»›ng dáº«n @ManyToMany]()

ğŸ’Â Náº¿u cÃ³, toÃ n bá»™ project / code máº«u Ä‘Æ°á»£c lÆ°u trá»¯ táº¡i **GitHub**

ğŸŒŸÂ ÄÃ¢y lÃ  má»™t bÃ i viáº¿t trongÂ Series **LÃ m chá»§ Spring Boot â€“ Zero to Hero**

