[SB17] Cháº¡y nhiá»u mÃ´i trÆ°á»ng vá»›i Spring Profile
=========================================================

The Wayback Machine - https://web.archive.org/web/20230602175051/https://loda.me/articles/sb17-chay-nhieu-moi-truong-voi-spring-profile

![Logo](https://web.archive.org/web/20230602175051im_/https://super-static-assets.s3.amazonaws.com/8a72ee8e-d4aa-4a06-985f-e92802c5bc44/uploads/logo/36872858-1bc0-4117-bb6b-81d9934b5275.svg)

- Home
- KhÃ³a há»c
- #dalog

Created

Oct 27, 2021 3:34 PM

- Giá»›i thiá»‡u
- 1\. Táº¡o file config
- #Â 2\. KÃ­ch hoáº¡t config
- 3\. CÃ¡ch sá»­ dá»¥ng @Profile
- Demo
- CÃ i Ä‘áº·t:
- #Â Táº¡o Model
- Cháº¡y thá»­
- Káº¿t

### **Giá»›i thiá»‡u**

Tiáº¿p ná»‘i seriesÂ **Spring Boot**:

1. [ğŸ“°\
\SB16\] HÆ°á»›ng dáº«n sá»­ dá»¥ng @ConfigurationPropertie

`Spring Profiles`Â lÃ  má»™t core feature trongÂ **Spring Framework**, cho phÃ©p chÃºng ta cáº¥u hÃ¬nh á»©ng dá»¥ng, active/deactiveÂ `Bean`Â tÃ¹y theo mÃ´i trÆ°á»ng.

Má»™t ká»‹ch báº£n thá»±c táº¿:

> MÃ¬nh cÃ³ 1 á»©ng dá»¥ngÂ Spring BootÂ dÃ¹ng Ä‘á»ƒ Ä‘á»c bÃ¡o, tuy nhiÃªn mÃ¬nh pháº£i hosting nÃ³ trÃªnÂ AWS. Váº¥n Ä‘á» lÃºc nÃ y lÃ  khi Ä‘ang viáº¿t code á»Ÿ local thÃ¬ mÃ¬nh cáº§n káº¿t ná»‘i vá»›iÂ MySQLÂ táº¡i mÃ¡y tÃ­nh cá»§a mÃ¬nh, khi Ä‘Æ°a lÃªn AWS thÃ¬ cáº§n káº¿t ná»‘i tá»›iÂ MySQLÂ cá»§aÂ AWS. NgoÃ i ra, chÆ°a ká»ƒ mÃ¬nh muá»‘n cáº¥u hÃ¬nh cÃ¡c biáº¿n cá»¥c bá»™ khÃ¡c cho phÃ¹ há»£p vá»›i mÃ´i trÆ°á»ng nhÆ°Â log,Â redis,Â secret, v.v.. Ä‘áº·c biá»‡t lÃ  viá»‡c má»™t sá»‘ pháº§n trong code cÃ³ thá»ƒ thay Ä‘á»•i theo mÃ´i trÆ°á»ng ná»¯a.

```
constants:
  service:
    phase: ALPHA
    debug:truespring:
  redis:
    clusterUri: redis://abdheyj3847A@10.127.155.18:7000
  datasource:
    username: xxx
    password: none
    url: jdbc:mysql://10.127.233.12:2030/news?useSSL=false&characterEncoding=UTF-8

news:
  api:
    channel-id: 1510354028
    channel-secret: e17c94a02293b33a32629407b32b40a5
    official-account-mid:
    connection-timeout-secs: 20
    .
    .
    ..
```

ráº¥t ráº¥t nhiá»u config pháº£i khÃ´ng :((((

Sá»›m nháº­n ra nhá»¯ng khÃ³ khÄƒn trong viá»‡c config khi xÃ¢y dá»±ng á»©ng dá»¥ng, nÃªn Spring Ä‘Ã£ cho ra Ä‘á»iÂ `Spring Profiles`Â Ä‘á»ƒ giáº£i quyáº¿t cÃ¡c váº¥n Ä‘á» nÃ y.

### **1\. Táº¡o file config**

`Spring Profiles`Â cÃ³ sáºµn trong Framework rá»“i nÃªn báº¡n khÃ´ng cáº§n thÃªm báº¥t kÃ¬ thÆ° viá»‡n nÃ o khÃ¡c.

Äá»ƒ sá»­ dá»¥ng, cÃ¡c báº¡n táº¡o file config táº¡i thÆ° má»¥cÂ `resources`Â trong project. Máº·c Ä‘á»‹nh Spring sáº½ nháº­n cÃ¡c file cÃ³ tÃªn nhÆ° sau:

```
application.properties
application.yml
application-{profile-name}.yml // .properties
```

vÃ­ dá»¥ mÃ¬nh cÃ³ 2 mÃ´i trÆ°á»ng lÃ Â `local`Â vÃ Â `aws`, thÃ¬ mÃ¬nh sáº½ táº¡o ra cÃ¡c file nhÆ° tháº¿ nÃ y:

```
application.yml
application-local.yml
application-aws.yml
application-common.yml
```

- `application`Â lÃ  file config chÃ­nh khai bÃ¡o cÃ¡c enviroment.
- `application-local`Â chá»‰ sá»­ dá»¥ng khi cháº¡y chÆ°Æ¡ng trÃ¬nh á»Ÿ local
- `application-aws`Â chá»‰ sá»­ dá»¥ng khi cháº¡y á»Ÿ AWS
- `application-common`Â lÃ  nhá»¯ng config dÃ¹ng chung, mÃ´i trÆ°á»ng nÃ o cÅ©ng cáº§n.

BÃ¢y giá», mÃ¬nh sáº½ khai bÃ¡o trong tá»«ng file nhÆ° sau:

_application.yml_

```
#application.yml
---
spring.profiles: local
spring.profiles.include: common, local
---
spring.profiles: aws
spring.profiles.include: common, aws
---
```

_application-aws.yml_

```
spring:
  datasource:
    username: xxx
    password: xxx
    url: jdbc:mysql://10.127.24.12:2030/news?useSSL=false&characterEncoding=UTF-8
```

_application-local.yml_

```
spring:
  datasource:
    username: root
    password:
    url: jdbc:mysql://localhost:3306/news?useSSL=false&characterEncoding=UTF-8

logging:
  level:
    org:
      hibernate:
        SQL: debug
```

_application-common.yml_

```
spring:
  jpa:
    properties:
      hibernate:
        jdbc:
          batch_size: 50
          batch_versioned_data:truehibernate:
      ddl-auto: none
```

Tadaa, xong, mÃ¬nh giáº£i thÃ­ch chÃºt. báº¡n Ä‘á»ƒ Ã½ trong fileÂ `application.yml`Â mÃ¬nh cÃ³ khai bÃ¡o 2 mÃ´i trÆ°á»ng lÃ Â `local`Â vÃ Â `aws`. Táº¡i má»—i mÃ´i trÆ°á»ng sáº½Â `include`Â (bao gá»“m) cÃ¡c file config nhÆ° kia. Khi mÃ¬nh kÃ­ch hoáº¡tÂ `aws`Â cháº³ng háº¡n,Â _Spring_Â sáº½ load táº¥t cáº£ config cÃ³ trongÂ `application-common.yml`Â vÃ Â `application-aws.yml`. Ráº¥t tiá»‡n pháº£i khÃ´ng :3

### **\#****2\. KÃ­ch hoáº¡t config**

Äá»ƒ sá»­ dá»¥ng má»™tÂ `Profiles`Â báº¡n cÃ³ cÃ¡c cÃ¡ch sau:

**#1: Sá»­ dá»¥ng**`spring.profiles.active`**trong file**`application.properties`**hoáº·c**`application.yml`

```
spring.profiles.active=aws
```

**2: Active trong code, trÆ°á»›c khi cháº¡y chÆ°Æ¡ng trÃ¬nh.**

```
@Configuration
public class ApplicationInitializer
  implements WebApplicationInitializer {

    @Override
    public void onStartup(ServletContext servletContext) throws ServletException {
        servletContext.setInitParameter(
          "spring.profiles.active", "aws");
    }
}
```

hoáº·c

```
@Autowired
private ConfigurableEnvironment env;
...
env.setActiveProfiles("aws");
```

hoáº·c

```
SpringApplication application = new SpringApplication(SpringBootProfilesApplication.class);
ConfigurableEnvironment environment = new StandardEnvironment();
environment.setActiveProfiles("aws");
application.setEnvironment(environment);
application.run(args);
```

MÃ¬nh khÃ´ng khuyáº¿n khÃ­ch cáº£ 3 cÃ¡ch nÃ y ==!

**3: Sá»­ dá»¥ng JVM System Parameter (nÃªn dÃ¹ng)**

```
-Dspring.profiles.active=aws
```

**4: Environment Variable (Unix) (nÃªn dÃ¹ng)**

```
export SPRING_PROFILES_ACTIVE=aws
```

Náº¿u ai sá»­ dá»¥ng

thÃ¬ cÃ³ thá»ƒ config ngay trong IDE nhÆ° tháº¿ nÃ y, má»—i láº§n cháº¡y nÃ³ tá»± active cho mÃ¬nh.

!image

### **3\. CÃ¡ch sá»­ dá»¥ng @Profile**

Khi Ä‘Ã£ cÃ³Â `Profile`Â rá»“i, ngoÃ i cÃ¡c biáº¿n toÃ n cá»¥c Ä‘Æ°á»£c thay Ä‘á»•i theo mÃ´i trÆ°á»ng, báº¡n cÅ©ng cÃ³ thá»ƒ toÃ n quyá»n quyáº¿t Ä‘á»‹nh xem trong code ráº±ngÂ `Bean`Â hayÂ `Class`Â nÃ o sáº½ Ä‘Æ°á»£c quyá»n cháº¡y á»Ÿ mÃ´i trÆ°á»ng nÃ o. Báº±ng cÃ¡ch sá»­ dá»¥ng annotationÂ `@Profile`

```
// Bean nÃ y Spring chá»‰ khá»Ÿi táº¡o vÃ  quáº£n lÃ½ khi mÃ´i trÆ°á»ng lÃ  `local`
@Component
@Profile("local")
public class LocalDatasourceConfig
```

NgoÃ i ra báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng toÃ n tá»­ logic á»Ÿ Ä‘Ã¢y, vÃ­ dá»¥:

```
// Bean nÃ y Spring chá»‰ khá»Ÿi táº¡o vÃ  quáº£n lÃ½ khi mÃ´i trÆ°á»ng lÃ  nhá»¯ng mÃ´i trÆ°á»ng khÃ´ng pháº£i lÃ  `local`
@Component
@Profile("!local")
public class LocalDatasourceConfig
```

### **Demo**

### **CÃ i Ä‘áº·t:**

_pom.xml_

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <packaging>pom</packaging>

  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.1.4.RELEASE</version>
    <relativePath /> <!-- lookup parent from repository -->
  </parent>
  <groupId>me.loda.spring</groupId>
  <artifactId>spring-boot-learning</artifactId>
  <version>0.0.1-SNAPSHOT</version>
  <name>spring-boot-learning</name>
  <description>Everything about Spring Boot</description>

  <properties>
    <java.version>1.8</java.version>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <optional>true</optional>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
      </plugin>
    </plugins>
  </build>

</project>
```

Cáº¥u trÃºc thÆ° má»¥c:

!image

### **\#****Táº¡o Model**

ChÃºng ta sáº½ táº¡o ra má»™t class lÃ Â `LocalDatasource`, vÃ  kiá»ƒm tra xem, khi thay Ä‘á»•i profile thÃ¬ nÃ³ sáº½ Ä‘Æ°á»£c táº¡o ra hay khÃ´ng.

Trong bÃ i viáº¿t cÃ³ sá»­ dá»¥ngÂ Lombok

_LocalDatasource.java_

```
@Data
@AllArgsConstructor
public class LocalDatasource {
    private String url;
}
```

_LocalDatasourceConfig_

```
/**
 * Chá»‰ khi profiles lÃ  "local"
 * ThÃ¬ Configuration dÆ°á»›i Ä‘Ã¢y má»›i Ä‘Æ°á»£c khá»Ÿi táº¡o
 */
@Configuration
@Profile("local")
public class LocalDatasourceConfig {

    @Bean
    public LocalDatasource localDatasource() {
        return new LocalDatasource("Local object, Chá»‰ khá»Ÿi táº¡o khi 'local' profile active");
    }
}
```

### **Cháº¡y thá»­**

_App.java_

```
@SpringBootApplication
public class App {

    public static void main(String[] args) {
//        SpringApplication.run(App.class, args);

        SpringApplication application = new SpringApplication(App.class);
        ConfigurableEnvironment environment = new StandardEnvironment();
//        Thay Ä‘á»•i mÃ´i trÆ°á»ng báº±ng cÃ¡ch comment vÃ  xem káº¿t quáº£
//        environment.setActiveProfiles("local");
        environment.setActiveProfiles("aws");
        application.setEnvironment(environment);
        ApplicationContext context = application.run(args);

        LocalDatasource localDatasource = context.getBean(LocalDatasource.class);
        System.out.println(localDatasource);
    }
```

Khi mÃ¬nh Ä‘á»ƒ profile lÃ Â `aws`Â thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ tráº£ vá» lá»—i:

```
No qualifying bean of type 'me.loda.spring.springprofiles.LocalDatasource' available
```

Äáº¡i Ã½ lÃ  beanÂ `LocalDatasource`Â khÃ´ng há» tá»“n táº¡i trongÂ `Context`.

CÃ²n khi kÃ­ch hoáº¡t profileÂ `local`Â thÃ¬ output chÆ°Æ¡ng trÃ¬nh sáº½ lÃ :

```
LocalDatasource(url=Local object, Chá»‰ khá»Ÿi táº¡o khi 'local' profile active)
```

### **Káº¿t**

Okiee lahhh, tháº¿ lÃ  mÃ¬nh Ä‘Ã£ giá»›i thiá»‡u xong vá»›i cÃ¡c báº¡nÂ `Spring Profiles`, ÄÃ¢y lÃ  má»™t tÃ­nh nÄƒng cá»±c kÃ¬ cá»±c kÃ¬ há»¯u Ã­ch, hi vá»ng cÃ¡c báº¡n hiá»ƒu vÃ  náº¯m Ä‘Æ°á»£c kiáº¿n thá»©c, Ã¡p dá»¥ng vÃ o sáº£n pháº©m cá»§a chÃ­nh mÃ¬nh. ChÃºc cÃ¡c báº¡n thÃ nh cÃ´ng!

ğŸ’Â Náº¿u cÃ³, toÃ n bá»™ project / code máº«u Ä‘Æ°á»£c lÆ°u trá»¯ táº¡i **GitHub**

ğŸŒŸÂ ÄÃ¢y lÃ  má»™t bÃ i viáº¿t trongÂ Series **LÃ m chá»§ Spring Boot â€“ Zero to Hero**

_Náº¿u báº¡n phÃ¡t hiá»‡n bÃ i viáº¿t cÃ³ lá»—i hoáº·c outdated, hÃ£y bÃ¡o láº¡i giÃºp mÃ¬nh theo email:__loda.namnh@gmail.com__hoáº·c qua__Nam HoÃ ng Nguyá»…n (facebook.com)_





